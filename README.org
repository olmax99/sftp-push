#+TITLE: Sftppush Event Pipeline
#+SETUPFILE: ~/s3olmax/org/conf/setup.config
#+FILETAGS: :candisolar:sftp:bhiwadi:

[[https://travis-ci.com/olmax99/sftppush.svg?branch=master][https://travis-ci.com/olmax99/sftppush.svg?branch=master]]

The *sftppush* is a mini pipeline for =upload > decompress > s3 archive=.

Initially, it was intended to replace i.e. low-compute serverless functions that
would simply push files from the Sftp server into an S3 Bucket location. Instead
of mounting an Sftp server's file system directly onto S3 FUSE this solution
seems to be more fit for production use cases.

* Prerequisites
- Go 1.13.x

* Design
# #+CAPTION: project
# #+attr_html: :width 200px
# [[file:images/helm-plus-metabase.png][file:./images/*.png]]

Most likely you want to run this project inside an Sftp server, that receives a
constant stream of data files.

The *sftppush* project is intended to run in a Linux (Ubuntu/Debian) VM. It
captures WRITE_CLOSE events for files on the file system based on a single or
multiple target directories.

The =watch --target= flag can read a single directory as well as a configuration
file containing multiple directories. In case of multiple directory targets
their will be a separate =go watch process= spawned for each target, respectively. 

It will decompress those files depending on their format and will push those
further to an AWS S3 Bucket location. 

* Quick Launch
** 1. Configure a single S3 Bucket location
...

** 2. Run the event watcher on a single local directory 
Running it should be as simple as:
#+BEGIN_SRC 
$ make build
$ bin/sftppush-0.1.0-linux_amd64 help
$ bin/sftppush-0.1.0-linux_amd64 watch --target local_test_dir/
#+END_SRC

Create a file in your =local_test_dir= and it should appear in your S3 Bucket location. 

* Getting Started
...

* Testing
Some tests require the OS file system. You can choose to run the tests inside a
Docker container.
#+BEGIN_SRC 
$ [DOCKER=1] make test

#+END_SRC

* General Instructions
** 1. Missing WRITE_CLOSE event
- WRITE_CLOSE events are not cross-platform, and currently only readily
  accessible on Linux file systems. This restriction made the [[https://github.com/fsnotify/fsnotify][fsnotify]] creators
  to keep the [[https://github.com/fsnotify/fsnotify/pull/313/commits/f8197a386f88a88067d4cea863694c73ab561c55][respective PR]] in pending state.
- Note that this =sftppush= project is relying heavily on this feature.
- One way of doing it is to fork the original [[https://github.com/fsnotify/fsnotify][fsnotify]], and accepting the
  changes made on the [[https://github.com/fsnotify/fsnotify/pull/313][respective PR]]. 

